# config.yml (clean & SR-focused)

# 用于日志目录命名：logs/<checkpoint><timestamp>/
checkpoint: "INR_Saliency_SR_v3"

# -----------------------
# Dataset roots (for CLAM slicing/export)
# train.py 会构建 image_dict 并调用 slic_tool.run_clam_and_export
# -----------------------
TCGA_LUAD:
  root: "/mnt/lwx/pyworkspace/multi-sur/data/TCGA-LUAD/"
  choose_WSI: 50

TCGA_KIRC:
  root: "/mnt/lwx/pyworkspace/multi-sur/data/TCGA-KIRC/"
  choose_WSI: 50

TCGA_LIHC:
  root: "/mnt/lwx/pyworkspace/multi-sur/data/TCGA-LIHC/"
  choose_WSI: 50

# -----------------------
# Data loader / preprocessing settings
# 这些字段在 train.py 中被直接读取
# -----------------------
data_loader:
  # 输出目录（必须符合你的 loader.py 读取约定）
  # out_img_dir/
  #   hr_png/<slide_id>/patch_xxx.png
  #   lr_png/<slide_id>/patch_xxx.png
  #   clinical.tsv
  out_img_dir: "/mnt/liangjm/SpRR_data/"

  # CLAM 切片导出参数
  patch_size: 512
  step_size: 512
  patch_level: 0
  down_scale: 4
  min_tissue_ratio: 0.5

  # 数据加载
  num_workers: 8
  pin_memory: true

  # 控制随机性 & split
  seed: 2025
  patch_num: 200         # build_case_split_dataloaders 用于每个 slide/case 抽样 patch 数（按你 loader 实现）
  train_ratio: 0.7
  val_ratio: 0.1
  test_ratio: 0.2

  skip_slicing: false

# -----------------------
# Model settings (INR + DINOv2 saliency guidance)
# train.py 会用这些超参构建 SRModelConfig / SRModel
# -----------------------
model:
  use_hovernet_guidance: true
  hovernet_pretrained_name: "hgsc_v1_efficientnet_b5"
  hovernet_use_gray: true
  hovernet_mix_beta: 0.5
  hovernet_weight_alpha: 1.0
  feat_ch: 64
  pe_bands: 10
  mlp_hidden: 256
  mlp_depth: 5

  kernel_size: 7

  num_points: 4096
  saliency_ratio: 0.7
  loss_alpha: 3.0

  lambda_grad: 0.2
  grad_crop: 128

  infer_chunk: 8192

  use_dino_saliency: true
  dino_hf_dir: "src/models/dinov2_vitb14"

  kernel_allow_negative: true

  # mixed saliency
  saliency_mix_beta: 0.4     # 0.3~0.5 推荐

  # residual SR
  use_residual: true
  use_res_refiner: true     # 先 false，稳定后再 true

  # temperature annealing
  tau_start: 1.0
  tau_end: 0.5
  tau_warm_epochs: 2
  tau_anneal_epochs: 8


# -----------------------
# Trainer settings
# -----------------------
trainer:
  epochs: 50
  batch_size: 8
  lr: 1.0e-4
  weight_decay: 1.0e-4
  grad_clip: 1.0
  log_every: 50
  use_amp: true

# -----------------------
# Validation / checkpoint / visualization
# -----------------------
validator:
  do_val: true
  max_batches: -1            # -1 表示验证集全跑；若只想抽样验证可设为正数
  metric_for_best: "lpips"    # 你也可以改成 "lpips"（注意 best 方向相反）
  best_mode: "min"           # psnr/ssim -> max；lpips -> min

  # 每轮验证保存一张随机可视化：HR / LR_up / SR 拼接图
  save_vis: true
  vis_subdir: "val_vis"
